<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Glucose Curve</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
  
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; background-color: #f8f9fa; }
    h1 { margin: 0 0 12px; font-size: 24px; color: #333; }
    .row { display:flex; gap: 12px; align-items:center; flex-wrap: wrap; margin-bottom: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    #popup {
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      border: 1px solid #ddd; background: #fff; border-radius: 12px;
      padding: 12px; display: none; box-shadow: 0 8px 32px rgba(0,0,0,.12);
      z-index: 1000;
    }
    #popup .title { font-weight: 700; margin-bottom: 6px; }
    #popup .close { float:right; cursor:pointer; padding: 4px 8px; border:1px solid #ddd; border-radius: 8px; }
    
    canvas { width: 100% !important; max-height: 420px; }
    select, input, button { padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 14px; }
    button { cursor: pointer; background-color: #007aff; color: white; border: none; font-weight: 600; padding: 8px 16px; }
    button:hover { background-color: #0056b3; }

    /* Sleep Legend Styling */
    .sleep-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      font-size: 13px;
      color: #666;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .color-box { width: 16px; height: 16px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Glucose Curve</h1>

  <div class="row card">
    <label>Date: <input id="date" type="date" value="{{ default_date }}"></label>
    <label>End Time: <input id="time" type="time"></label>
    <label>Range:
      <select id="range">
        <option value="3">3 hr</option>
        <option value="6" selected>6 hr</option>
        <option value="12">12 hr</option>
        <option value="24">24 hr</option>
      </select>
    </label>
    <button id="load">Load Data</button>
  </div>

  <div class="card">
    <div style="height: 420px; position: relative;">
      <canvas id="chart"></canvas>
    </div>
    <div id="sleepLegend" class="sleep-legend"></div>
  </div>

  <div id="popup">
    <span class="close" id="popupClose">Close</span>
    <div class="title" id="popupTitle"></div>
    <div id="popupBody"></div>
  </div>

<script>
let chart;
const icons = { meal: "ðŸ½ï¸", workout: "ðŸƒ", exercise: "ðŸ’ª", med: "ðŸ’Š", weight: "âš–ï¸" };

const sleepColors = {
  "deep": "rgba(46, 134, 193, 0.3)",
  "core": "rgba(93, 173, 226, 0.2)",
  "rem": "rgba(175, 122, 197, 0.3)",
  "awake": "rgba(231, 76, 60, 0.2)"
};

const customLabelPlugin = {
  id: 'customLabels',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    chart.data.datasets.forEach((dataset, dsIndex) => {
      if (dataset.type !== 'scatter') return;
      const meta = chart.getDatasetMeta(dsIndex);
      
      // VARIABLES TO TRACK OVERLAP
      let lastX = -999; 
      let staggerY = 0; 

      meta.data.forEach((element, index) => {
        if (element.skip) return;
        const dataPoint = dataset.data[index];
        if (dataPoint && dataPoint._meta) {
          const { x, y } = element.getProps(['x', 'y'], true);
          
          // --- STAGGER LOGIC START ---
          // If the current icon is within 60px of the last one, move text down
          if (Math.abs(x - lastX) < 60) {
             staggerY += 12; // Shift down by 12px
          } else {
             staggerY = 0;   // Reset if far enough apart
          }
          lastX = x;
          // --- STAGGER LOGIC END ---

          const metaData = dataPoint._meta;
          const kind = metaData.kind;
          
          ctx.save();
          ctx.font = '16px system-ui';
          ctx.textAlign = 'center';
          
          // Draw Icon (Icon always stays at original Y)
          ctx.fillText(icons[kind], x, y);

          // Sub-labels for items
          ctx.font = 'bold 10px system-ui';
          ctx.fillStyle = '#444';
          ctx.textAlign = 'left';

          let labelText = "";
          if (kind === 'meal') labelText = `${metaData.m.meal_template_name} (${metaData.m.total_carbs_g}g)`;
          if (kind === 'workout') labelText = `${metaData.w.activity_type} (${Math.round(metaData.w.duration_min)}m)`;
          
          if (kind === 'exercise') {
              const weightVal = parseFloat(metaData.ex.weight_kg);
              const weightText = weightVal > 0 ? ` @ ${weightVal}kg` : "";
              labelText = `${metaData.ex.name}: ${metaData.ex.reps} reps${weightText}`;
          }

          if (kind === 'med') {
              labelText = `${metaData.m.label} (${metaData.m.dose_mg}mg)`;
          }

          if (labelText) {
             // Apply the staggerY offset to the text ONLY
             ctx.fillText(labelText, x + 12, y + 3 + staggerY);
          }
          ctx.restore();
        }
      });
    });
  }
};

function generateSleepLegend() {
  const legendContainer = document.getElementById("sleepLegend");
  legendContainer.innerHTML = "";
  const stages = [
    { key: "deep", label: "Deep Sleep" },
    { key: "core", label: "Core / Light" },
    { key: "rem", label: "REM" },
    { key: "awake", label: "Awake" }
  ];
  stages.forEach(s => {
    const div = document.createElement("div");
    div.className = "legend-item";
    div.innerHTML = `<div class="color-box" style="background-color: ${sleepColors[s.key]}"></div><span>${s.label}</span>`;
    legendContainer.appendChild(div);
  });
}

function showPopup(title, html) {
  document.getElementById("popupTitle").textContent = title;
  document.getElementById("popupBody").innerHTML = html;
  document.getElementById("popup").style.display = "block";
}
document.getElementById("popupClose").onclick = () => document.getElementById("popup").style.display = "none";

async function loadData() {
  const dateVal = document.getElementById("date").value;
  const rangeVal = document.getElementById("range").value;
  const timeVal = document.getElementById("time").value;

  let url = `/api/timeline/?date=${encodeURIComponent(dateVal)}&range_hours=${encodeURIComponent(rangeVal)}`;
  if (timeVal) url += `&start_time=${encodeURIComponent(timeVal)}`;

  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.ok) return alert("Error: " + data.error);

    const egv = data.egv.map(p => ({ x: new Date(p.t), y: p.y }));
    const yMax = egv.length ? Math.max(...egv.map(p => p.y)) : 150;
    const yTop = yMax + 25;

    // 1. Map Sleep Data to Annotations
    const sleepAnnotations = {};
    if (data.sleep) {
      data.sleep.forEach((s, idx) => {
        const stageKey = s.stage.toLowerCase().replace("asleep", "").trim();
        sleepAnnotations[`sleep${idx}`] = {
          type: 'box',
          xMin: new Date(s.start),
          xMax: new Date(s.end),
          backgroundColor: sleepColors[stageKey] || "rgba(200,200,200,0.1)",
          borderWidth: 0,
          drawTime: 'beforeDatasetsDraw' 
        };
      });
      generateSleepLegend();
    }

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById("chart"), {
      data: {
        datasets: [
          {
            type: "line",
            label: "Glucose",
            data: egv,
            borderColor: '#007aff',
            borderWidth: 3,
            pointRadius: 0,
            tension: 0.3,
            fill: false
          },
          {
            label: "Meals",
            type: "scatter",
            data: data.meals.map(m => ({ x: new Date(m.eaten_at), y: yTop, _meta: { kind:"meal", m } }))
          },
          {
            label: "Workouts",
            type: "scatter",
            data: data.workouts.map(w => ({ x: new Date(w.start_at), y: yTop - 18, _meta: { kind:"workout", w } }))
          },
          {
            label: "Exercise Sets",
            type: "scatter",
            data: (data.exercise_sets || []).map(ex => ({ x: new Date(ex.t), y: yTop - 36, _meta: { kind:"exercise", ex } }))
          },
          {
            label: "Meds",
            type: "scatter",
            data: (data.medications || []).map(m => ({ x: new Date(m.taken_at), y: yTop - 54, _meta: { kind:"med", m } }))
          }
        ]
      },
      plugins: [customLabelPlugin],
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { 
            type: "time", 
            min: new Date(data.start), 
            max: new Date(data.end),
            time: { unit: 'hour', displayFormats: { hour: 'h a' } }
          },
          y: { suggestedMin: 70, suggestedMax: yTop + 10, title: { display: true, text: 'mg/dL' } }
        },
        plugins: {
          legend: { display: false },
          annotation: { annotations: sleepAnnotations }
        },
        onClick: (e, el) => {
          if (!el.length) return;
          const ds = chart.data.datasets[el[0].datasetIndex];
          const pt = ds.data[el[0].index];
          if (pt._meta) {
              const m = pt._meta;
              if (m.kind === 'meal') showPopup("Meal", `<b>${m.m.meal_template_name}</b><br>${m.m.total_carbs_g}g Carbs`);
              if (m.kind === 'workout') showPopup("Workout", `<b>${m.w.activity_type}</b><br>${m.w.duration_min} mins`);
              if (m.kind === 'exercise') showPopup("Exercise", `<b>${m.ex.name}</b><br>${m.ex.reps} reps`);
              if (m.kind === 'med') showPopup("Medication", `<b>${m.m.label}</b><br>${m.m.dose_mg}mg<br>${m.m.notes || ''}`);
          }
        }
      }
    });
  } catch (e) { console.error(e); }
}

document.getElementById("load").onclick = loadData;
window.onload = loadData;
</script>
</body>
</html>